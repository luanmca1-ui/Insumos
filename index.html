<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedido de Insumos</title>
  <style>
    :root {
      --bg: #0a0f1c;
      --card: #0f1729;
      --text: #f8fafc;
      --muted: #cbd5e1;
      --accent: #e63946;
      --accent-2: #fbbf24;
      --outline: rgba(230, 57, 70, 0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #1d2a44, #0a0f1c 55%), #0a0f1c;
      color: var(--text);
      display: flex;
      justify-content: center;
    }
    .card {
      width: min(860px, 100%);
      background: linear-gradient(135deg, rgba(15,23,41,0.94), rgba(15,23,41,0.88));
      padding: 18px 16px 22px;
      border-radius: 16px;
      box-shadow: 0 16px 45px rgba(0,0,0,0.32);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .brand .logo {
      width: 72px;
      height: 72px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .brand .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    .brand .logo .logo-fallback {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: 1px;
      color: rgba(255,255,255,0.8);
      background: linear-gradient(135deg, rgba(230,57,70,0.18), rgba(15,23,41,0.5));
      opacity: 0;
      transition: opacity 150ms ease;
    }
    .brand .name {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    h1 { margin: 0 0 6px; font-size: 21px; }
    p.subtitle { margin: 0 0 12px; color: var(--muted); }
    label { display: block; margin-top: 10px; font-weight: 600; }
    input, textarea, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      color: var(--text);
    }
    select option { background: #0f1729; color: var(--text); }
    input:focus, textarea:focus, select:focus {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 3px var(--outline);
    }
    button {
      margin-top: 12px;
      width: 100%;
      padding: 11px 12px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(120deg, var(--accent), #f97316);
      color: #0b1220;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 12px 24px rgba(249,115,22,0.35); }
    .secondary-btn {
      width: auto;
      margin-top: 0;
      padding: 8px 10px;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .danger-btn {
      width: auto;
      margin-top: 0;
      padding: 8px 10px;
      background: rgba(230,57,70,0.2);
      color: #ffd7db;
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid rgba(230,57,70,0.4);
    }
    .muted { color: var(--muted); font-size: 13px; margin-top: 6px; }
    #status { margin-top: 14px; white-space: pre-line; color: var(--accent-2); }

    .fav-header {
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .fav-list { margin-top: 10px; display: grid; gap: 12px; }
    .fav-card {
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      padding: 12px;
    }
    .fav-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .fav-card-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: var(--accent-2);
    }
    .fav-toggle {
      width: 28px;
      height: 28px;
      min-width: 28px;
      border-radius: 8px;
      margin-top: 0;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      background: rgba(255,255,255,0.1);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .fav-content { margin-top: 6px; }
    .fav-card.collapsed .fav-content { display: none; }
    .fav-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .item-list { margin-top: 10px; display: grid; gap: 10px; }
    .item-row {
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
    }
    .item-row .hint { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .item-row .preview { font-size: 13px; color: var(--accent-2); margin-top: 6px; }
    .item-row .row-actions { margin-top: 8px; display: flex; justify-content: flex-end; }

    .suggestions {
      position: absolute;
      z-index: 10;
      background: #0f1729;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      margin-top: 6px;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      width: 100%;
    }
    .suggestions div { padding: 8px 10px; cursor: pointer; color: var(--text); }
    .suggestions div:hover { background: rgba(255,255,255,0.08); }

    .insumo-input { padding-right: 44px; }
    .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--text);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 11px;
      line-height: 22px;
      z-index: 2;
      padding: 0;
    }
    .clear-btn:hover { background: rgba(255,255,255,0.14); }

    @media (max-width: 640px) {
      body { padding: 14px; }
      .card { padding: 14px; }
      h1 { font-size: 20px; }
      .brand .logo { width: 60px; height: 60px; }
      .fav-actions { flex-direction: column; }
      .secondary-btn, .danger-btn { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="brand">
      <div class="logo">
        <img src="assets/logo.png" alt="THE BARBER EXPRESS" onerror="this.style.display='none'; this.nextElementSibling.style.opacity='1';" />
        <div class="logo-fallback">TBE</div>
      </div>
      <div class="name">THE BARBER EXPRESS</div>
    </div>

    <h1>Pedido de Insumos</h1>
    <p class="subtitle">Responsavel pelo envio e unico. Itens sempre ficam dentro de um favorecido.</p>

    <form id="insumoForm">
      <label>Barbearia
        <select name="barbearia" required>
          <option value="" disabled selected>Selecione a unidade</option>
          <option>TBE TROPICAL</option>
          <option>TBE PATIO NORTE</option>
          <option>TBE BENFICA</option>
          <option>TBE BEAUTY EXPRESS</option>
          <option>TBE MARABA</option>
          <option>TBE METROPOLE</option>
          <option>TBE BOA VISTA</option>
          <option>TBE BOULEVARD</option>
          <option>TBE TACARUNA</option>
          <option>TBE PATIO BELEM</option>
          <option>TBE PARQUE</option>
          <option>TBE SAO LUIS</option>
          <option>TBE PARAGABA</option>
          <option>TBE CASTANHEIRA</option>
          <option>TBE LIGHT</option>
          <option>TBE IANDE</option>
          <option>TBE BOAVISTA SP</option>
        </select>
      </label>

      <label>Responsavel pelo envio
        <input name="responsavelEnvio" placeholder="Quem preencheu o pedido" required />
      </label>

      <div class="fav-header">
        <h3 style="margin:0">Favorecidos</h3>
        <button type="button" class="secondary-btn" id="addFavorecido">Adicionar favorecido</button>
      </div>
      <div id="favorecidos" class="fav-list"></div>

      <button type="submit">Salvar pedido</button>
    </form>

    <div id="status"></div>
    <button type="button" id="copyBtn" class="secondary-btn" style="margin-top:8px; width:100%;" disabled>Copiar resumo</button>
    <p class="muted">Apos salvar, voce pode copiar o resumo com o botao acima.</p>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbySESHU3H8ylzuvpwfKVsmQ9u8w27j6JfyC120e-WaXHOaI9Q3hg4d06UJGGmwup6qC/exec';

    const form = document.getElementById('insumoForm');
    const statusEl = document.getElementById('status');
    const copyBtn = document.getElementById('copyBtn');
    const addFavorecidoBtn = document.getElementById('addFavorecido');
    const favorecidosContainer = document.getElementById('favorecidos');

    const INSUMOS = [
      'Agua mineral (com gas)', 'Agua mineral (sem gas)', 'Agua sanitaria', 'Alcool 70%', 'Alcool em gel', 'Algodao',
      'Amaciante de roupas', 'Amostras de produtos para clientes', 'Anotadores / blocos de notas',
      'Ar-condicionado (manutencao e pecas)', 'Aromatizador de ambiente', 'Aspirador de po (filtros e manutencao)',
      'Aventais para barbeiros', 'Balm para barba', 'Bancadas de trabalho', 'Baterias', 'Bebidas energeticas',
      'Bobinas para maquina de cartao', 'Borrifador de agua', 'Cadeiras de barbearia', 'Cafe (po, capsulas ou graos)',
      'Camisas / uniformes', 'Capas descartaveis para cliente', 'Carregadores de celular', 'Carrinhos auxiliares',
      'Cartoes de agendamento', 'Cartoes de fidelidade', 'Cartuchos / tinta de impressora', 'Cera capilar',
      'Cerveja long neck', 'Cestos de lixo', 'Cha', 'Climatizadores', 'Clorexidina', 'Copos descartaveis',
      'Copos personalizados', 'Creme leave-in', 'Desinfetante', 'Desinfetante para ferramentas', 'Detergente',
      'Detergente para lavar roupas', 'Envelopes', 'Escova de barba', 'Escova de cabelo', 'Escova de limpeza para maquinas',
      'Escova de pescoco', 'Espelhos', 'Espuma de barbear', 'Esterilizador UV', 'Etiquetas adesivas', 'Etiquetas de preco',
      'Extensoes eletricas', 'Fios / cabos de energia', 'Filtros de linha', 'Filtros de agua', 'Folhetos / flyers',
      'Fone de ouvido', 'Fusiveis', 'Gel de barbear', 'Gel para cabelo', 'Guardanapos', 'HD externo para backup',
      'Laminas de navalha descartaveis', 'Laminas para maquinas', 'Lampadas', 'Leave-in', 'Lencos umedecidos',
      'Locao pos-barba', 'Luvas descartaveis', 'Maquinas de acabamento / detalhe', 'Maquinas de corte profissional',
      'Marcadores', 'Mascaras descartaveis', 'Mexedores', 'Microfones para gravacao', 'Papel A4', 'Papel higienico',
      'Papel toalha', 'Pastas', 'Pentes de corte', 'Pentes de guia para maquina', 'Pepel toalha',
      'Pecas de reposicao de maquinas', 'Pilhas', 'Pincel para aplicacao de talco', 'Po de cafe / capsulas',
      'Pomada modeladora', 'Prateleiras', 'Protetor de pescoco descartavel (neck strip)', 'Quadros decorativos',
      'Rodos', 'Roteador Wi-Fi', 'Sabao liquido', 'Sabonete liquido', 'Saboneteira / dispenser', 'Sacos de lixo',
      'Spray de cabelo', 'Stone / pedra de afiar', 'Suportes de mesa (QR Code)', 'Talco', 'Tapetes anti-fadiga',
      'Tesoura de corte', 'Tesoura de desfiar', 'Toalhas descartaveis', 'Toalhas lavaveis', 'Toalhas umedecidas',
      'Tonicos capilares', 'Uniformes', 'Ventiladores', 'Vassouras'
    ];

    function formatCurrencyBRL(value) {
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function updatePreview(qtdInput, valorInput, previewEl) {
      const qty = Number(qtdInput.value) || 0;
      const val = Number(valorInput.value) || 0;
      const total = qty * val;
      previewEl.textContent = (qty === 0 && val === 0) ? '' : `Simulacao: ${qty} x ${formatCurrencyBRL(val)} = ${formatCurrencyBRL(total)}`;
    }

    function attachAutocomplete(inputEl, listEl) {
      const render = (term = '') => {
        const t = term.toLowerCase();
        const filtered = INSUMOS.filter((opt) => opt.toLowerCase().includes(t)).slice(0, 12);
        if (!filtered.length) {
          listEl.style.display = 'none';
          return;
        }
        listEl.innerHTML = filtered.map((opt) => `<div>${opt}</div>`).join('');
        listEl.style.display = 'block';
        [...listEl.children].forEach((div) => {
          div.addEventListener('click', () => {
            inputEl.value = div.textContent;
            listEl.style.display = 'none';
          });
        });
      };

      inputEl.addEventListener('focus', () => render(inputEl.value));
      inputEl.addEventListener('input', () => render(inputEl.value));
      inputEl.addEventListener('blur', () => {
        setTimeout(() => { listEl.style.display = 'none'; }, 120);
      });

      return render;
    }

    function createItemRow(itemListEl) {
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <label style="position: relative;">Nome do insumo
          <input class="insumo-input" name="insumo" placeholder="Digite ou selecione" autocomplete="off" required />
          <button type="button" class="clear-btn" title="Apagar insumo">x</button>
          <div class="suggestions" style="display:none;"></div>
        </label>
        <label>Quantidade
          <input name="quantidade" type="number" step="1" min="0" required />
        </label>
        <label>Valor (R$)
          <input name="valor" type="number" step="0.01" min="0" required />
          <div class="hint">O total e calculado automaticamente conforme voce digita.</div>
        </label>
        <label>Descricao
          <textarea name="descricao" rows="2" placeholder="Observacoes, marca preferida..."></textarea>
        </label>
        <div class="row-actions">
          <button type="button" class="danger-btn remove-item">Remover item</button>
        </div>
        <div class="preview"></div>
      `;

      const qtdInput = row.querySelector('input[name="quantidade"]');
      const valorInput = row.querySelector('input[name="valor"]');
      const previewEl = row.querySelector('.preview');
      const inputInsumo = row.querySelector('.insumo-input');
      const suggestionsEl = row.querySelector('.suggestions');
      const clearBtn = row.querySelector('.clear-btn');

      qtdInput.addEventListener('input', () => updatePreview(qtdInput, valorInput, previewEl));
      valorInput.addEventListener('input', () => updatePreview(qtdInput, valorInput, previewEl));
      updatePreview(qtdInput, valorInput, previewEl);

      const renderSuggestions = attachAutocomplete(inputInsumo, suggestionsEl);
      clearBtn.addEventListener('click', () => {
        inputInsumo.value = '';
        inputInsumo.focus();
        suggestionsEl.style.display = 'none';
        renderSuggestions('');
      });

      row.querySelector('.remove-item').addEventListener('click', () => {
        if (itemListEl.children.length > 1) {
          row.remove();
        }
      });

      return row;
    }

    function addItemToBlock(itemListEl) {
      itemListEl.appendChild(createItemRow(itemListEl));
    }

    function createFavorecidoCard() {
      const card = document.createElement('div');
      card.className = 'fav-card';
      card.innerHTML = `
        <div class="fav-top">
          <p class="fav-card-title">Favorecido</p>
          <button type="button" class="fav-toggle" title="Expandir/Recolher">+</button>
        </div>
        <div class="fav-content">
          <label>Nome do favorecido
            <input name="favorecido" placeholder="Quem vai comprar" required />
          </label>
          <label>PIX do favorecido
            <input name="pix" placeholder="Chave PIX" required />
          </label>
          <label style="margin-top:10px;">Itens desse favorecido</label>
          <div class="item-list"></div>
          <div class="fav-actions">
            <button type="button" class="secondary-btn add-item">Adicionar item</button>
            <button type="button" class="danger-btn remove-fav">Remover favorecido</button>
          </div>
        </div>
      `;

      const itemListEl = card.querySelector('.item-list');
      const titleEl = card.querySelector('.fav-card-title');
      const nameInput = card.querySelector('input[name="favorecido"]');
      const toggleBtn = card.querySelector('.fav-toggle');
      addItemToBlock(itemListEl);

      nameInput.addEventListener('input', () => refreshFavorecidoHeaders());
      card.querySelector('.add-item').addEventListener('click', () => addItemToBlock(itemListEl));
      toggleBtn.addEventListener('click', () => {
        card.classList.toggle('collapsed');
        updateCardToggle(card);
      });
      card.querySelector('.remove-fav').addEventListener('click', () => {
        if (favorecidosContainer.children.length > 1) {
          card.remove();
          refreshFavorecidoHeaders();
        }
      });

      titleEl.textContent = 'Favorecido';
      return card;
    }

    function updateCardToggle(card) {
      const btn = card.querySelector('.fav-toggle');
      btn.textContent = card.classList.contains('collapsed') ? '+' : '-';
    }

    function refreshFavorecidoHeaders() {
      const cards = Array.from(favorecidosContainer.querySelectorAll('.fav-card'));
      cards.forEach((card, idx) => {
        const name = card.querySelector('input[name="favorecido"]').value.trim();
        const titleEl = card.querySelector('.fav-card-title');
        titleEl.textContent = `Favorecido ${idx + 1}${name ? ' - ' + name : ''}`;
        updateCardToggle(card);
      });
    }

    function addFavorecidoCard() {
      const cards = Array.from(favorecidosContainer.querySelectorAll('.fav-card'));
      cards.forEach((card) => {
        card.classList.add('collapsed');
        updateCardToggle(card);
      });

      const newCard = createFavorecidoCard();
      favorecidosContainer.appendChild(newCard);
      newCard.classList.remove('collapsed');
      refreshFavorecidoHeaders();
    }

    addFavorecidoBtn.addEventListener('click', () => addFavorecidoCard());

    copyBtn.addEventListener('click', async () => {
      const text = statusEl.textContent;
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Copiado';
        setTimeout(() => (copyBtn.textContent = 'Copiar resumo'), 1200);
      } catch (_) {
        copyBtn.textContent = 'Erro ao copiar';
        setTimeout(() => (copyBtn.textContent = 'Copiar resumo'), 1200);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Enviando...';
      copyBtn.disabled = true;

      const barbearia = form.querySelector('select[name="barbearia"]').value;
      const responsavelEnvio = form.querySelector('input[name="responsavelEnvio"]').value;

      const favorecidos = Array.from(favorecidosContainer.querySelectorAll('.fav-card')).map((card) => {
        const favorecido = card.querySelector('input[name="favorecido"]').value.trim();
        const pix = card.querySelector('input[name="pix"]').value.trim();

        const items = Array.from(card.querySelectorAll('.item-row')).map((row) => ({
          insumo: row.querySelector('input[name="insumo"]').value.trim(),
          quantidade: row.querySelector('input[name="quantidade"]').value,
          valor: row.querySelector('input[name="valor"]').value,
          descricao: row.querySelector('textarea[name="descricao"]').value.trim()
        })).filter((item) => item.insumo);

        return { favorecido, pix, items };
      }).filter((f) => f.favorecido && f.pix && f.items.length > 0);

      if (!favorecidos.length) {
        statusEl.textContent = 'Adicione pelo menos um favorecido com item.';
        return;
      }

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ barbearia, responsavelEnvio, favorecidos })
        });

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Erro ao salvar');

        statusEl.textContent = data.resumo;
        copyBtn.disabled = false;
        form.reset();
        favorecidosContainer.innerHTML = '';
        addFavorecidoCard();
      } catch (err) {
        statusEl.textContent = 'Erro: ' + err.message;
      }
    });

    // inicial
    addFavorecidoCard();
  </script>
</body>
</html>
